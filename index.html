<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Route Generator</title>
    <style>
        #right-panel {
            font-family: 'Roboto','sans-serif';
            line-height: 30px;
            padding-left: 10px;
        }
        #right-panel select, #right-panel input {
            font-size: 15px;
        }
        #right-panel select {
            width: 100%;
        }
        #right-panel i {
            font-size: 12px;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
            float: left;
            width: 70%;
            height: 100%;
        }
        #right-panel {
            margin: 20px;
            border-width: 2px;
            width: 20%;
            height: 400px;
            float: left;
            text-align: left;
            padding-top: 0;
        }
        #distance {
            background-color: #fff;
            font-family: Roboto;
            font-size: 15px;
            font-weight: 300;
            margin-left: 12px;
            padding: 0 11px 0 13px;
            text-overflow: ellipsis;
            width: 300px;
        }
        #start {
            background-color: #fff;
            font-family: Roboto;
            font-size: 15px;
            font-weight: 300;
            margin-left: 12px;
            padding: 0 11px 0 13px;
            text-overflow: ellipsis;
            width: 300px;
        }
        #start:focus {
            border-color: #4d90fe;
        }
        #distance:focus {
            border-color: #4d90fe;
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="right-panel">
    <div>
        <b>Start:</b>
        <br>
        <input id="start", type = "text"
               placeholder="Enter a location">
        </input>
    </div>
    <div>
        <b>Distance(km):</b>
        <br>
        <input id="distance", type = "text"
               placeholder="Enter distance">
        </input>

    </div>
    <br>
    <input type="submit" id="submit" value = "Create Route">
    <div>
        <font size = "1"><a href="https://mapicons.mapsmarker.com">Maps Icons Collection</a></font>
    </div>
</div>
<script>
    var latlngArray = new Array();
    var numLatLng;
    function initMap() {
        Number.prototype.toRad = function() {
            return this * Math.PI / 180;
        }
        Number.prototype.toDeg = function() {
            return this * 180 / Math.PI;
        }
        google.maps.LatLng.prototype.destinationPoint = function(brng, dist) {
            dist = dist / 6371;
            brng = brng.toRad();
            var lat1 = this.lat().toRad(), lon1 = this.lng().toRad();
            var lat2 = Math.asin(Math.sin(lat1) * Math.cos(dist) +
                Math.cos(lat1) * Math.sin(dist) * Math.cos(brng));
            var lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(dist) *
                Math.cos(lat1),
                Math.cos(dist) - Math.sin(lat1) *
                Math.sin(lat2));
            if (isNaN(lat2) || isNaN(lon2)) return null;
            return new google.maps.LatLng(lat2.toDeg(), lon2.toDeg());
        }
        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer;
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 10,
            center: {lat: 49.283, lng: -123.12}
        });
        directionsDisplay.setMap(map);
        directionsDisplay.setOptions( { suppressMarkers: true } );
//        var infowindow = new google.maps.InfoWindow();
//        var infowindowContent = document.getElementById('infowindow-content');
//        infowindow.setContent(infowindowContent);
        var startMarkerIcon = 'https://raw.githubusercontent.com/Einzberg/einzberg.github.io/master/homeMarker.png';
        var marker = new google.maps.Marker({
            map: map,
            anchorPoint: new google.maps.Point(0, -29),
            icon: startMarkerIcon
        });
        // autocomplete starting location
        var start = document.getElementById('start');
        var autocomplete = new google.maps.places.Autocomplete(start);
        autocomplete.bindTo('bounds', map);
        autocomplete.addListener('place_changed', function() {
//            infowindow.close();
            marker.setVisible(false);
            var place = autocomplete.getPlace();
            if (!place.geometry) {
                // User entered the name of a Place that was not suggested and
                // pressed the Enter key, or the Place Details request failed.
                window.alert("No details available for input: '" + place.name + "'");
                return;
            }
            // If the place has a geometry, then present it on a map.
            if (place.geometry.viewport) {
                map.fitBounds(place.geometry.viewport);
            } else {
                map.setCenter(place.geometry.location);
                map.setZoom(17);  // Why 17? Because it looks good.
            }
            marker.setPosition(place.geometry.location);
            marker.setVisible(true);
            var address = '';
            if (place.address_components) {
                address = [
                    (place.address_components[0] && place.address_components[0].short_name || ''),
                    (place.address_components[1] && place.address_components[1].short_name || ''),
                    (place.address_components[2] && place.address_components[2].short_name || '')
                ].join(' ');
            }
//            infowindowContent.children['place-icon'].src = place.icon;
//            infowindowContent.children['place-name'].textContent = place.name;
//            infowindowContent.children['place-address'].textContent = address;
//            infowindow.open(map, marker);
        });
        // submit callback
        document.getElementById('submit').addEventListener('click', function() {
            latlngArray = new Array();
            drawCircleAndPoints(map, autocomplete);
            calculateAndDisplayRoute(directionsService, directionsDisplay);
        });
    }
    function drawCircleAndPoints(map, autocomplete) {
        // generate a random degree from 0 to 360
        var directionDeg = Math.random() * 360;

        var place = autocomplete.getPlace();
        if (!place) {
            window.alert("Please input valid start address.");
            return;
        }

        var lat = place.geometry.location.lat(),
            lng = place.geometry.location.lng();
        var startPoint = new google.maps.LatLng(lat, lng);

        var radius = parseFloat(document.getElementById('distance').value);
        if (isNaN(radius)) {
            window.alert("Please input valid distance value.");
            return;
        }

        radius = radius / (2 * 3.14159);
//        console.log("radius: ", radius);
        var midPoint = startPoint.destinationPoint(directionDeg, radius);
    
        numLatLng = 0;

        latlngArray[numLatLng] = midPoint.destinationPoint(90+directionDeg, radius),

        numLatLng++;

        latlngArray[numLatLng] = midPoint.destinationPoint(directionDeg, radius)

        numLatLng++;

        latlngArray[numLatLng] = midPoint.destinationPoint(270+directionDeg, radius)
        numLatLng++;
    }
    function calculateAndDisplayRoute(directionsService, directionsDisplay) {
        console.log("Calculating and Displaying Route");
        var wayPoints = [];
        console.log("LatLng Array: ", latlngArray);
        for (var i = 0; i < latlngArray.length; i++){
            console.log("Locations: ", latlngArray[i].position);
            var waypoint = new google.maps.LatLng(latlngArray[i].lat(), latlngArray[i].lng());
            wayPoints.push({
                location: waypoint,
                stopover: true
            })
        }

        directionsService.route({
            origin: document.getElementById('start').value,
            destination: document.getElementById('start').value,
            waypoints: wayPoints,
            optimizeWaypoints: true,
            travelMode: 'WALKING'
        }, function(response, status) {
            if (status === 'OK') {
                directionsDisplay.setDirections(response);
                var route = response.routes[0];
                var summaryPanel = document.getElementById('directions-panel');
                summaryPanel.innerHTML = '';
                // For each route, display summary information.
                for (var i = 0; i < route.legs.length; i++) {
                    var routeSegment = i + 1;
                    summaryPanel.innerHTML += '<b>Route Segment: ' + routeSegment +
                        '</b><br>';
                    summaryPanel.innerHTML += route.legs[i].start_address + ' to ';
                    summaryPanel.innerHTML += route.legs[i].end_address + '<br>';
                    summaryPanel.innerHTML += route.legs[i].distance.text + '<br><br>';
                }
            } else {
                window.alert('Directions request failed due to ' + status);
            }
        });
    }
</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDfGJ0LPRBlXWEyKNNGR3Ubuc0NMmDjMDs&libraries=places&callback=initMap">
</script>
</body>
</html>
